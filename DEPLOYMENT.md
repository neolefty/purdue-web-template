# Deployment Configuration System

## Overview

This Django-React template now includes a comprehensive deployment system that supports multiple deployment patterns and environments. The system uses templated configuration files to generate all necessary configs (nginx, systemd, gunicorn) from a single source of truth.

## Current Status

### ‚úÖ Completed
- Created flexible deployment system supporting two patterns:
  1. **Standard deployment** - App owns entire domain
  2. **Path-based deployment** - App served under URL prefix (e.g., `/dev/`)
  3. **Subdomain deployment** - Environment-based subdomains (e.g., `app-dev.domain.edu`)
- Template-based configuration generation for nginx, gunicorn, systemd
- Support for systemd socket activation
- Environment-specific configurations (dev/qa/prod)
- Automated setup scripts for multiple environments

### üîÑ Ready to Test
- Subdomain deployment on `django-template-{dev,qa,prod}.ag.purdue.edu`
- Systemd socket activation pattern
- nginx configuration with proper SSL and security headers
- Path-based routing configuration

### üìù TODO
- Test deployment on actual server
- Create Docker Compose configuration that emulates production setup
- Test SAML authentication with Purdue SSO
- Verify static file serving under different URL patterns
- Test database connections for each environment

## File Structure

All deployment files are organized in the `deployment/` directory:

### Core Deployment Scripts
```
deployment/
‚îú‚îÄ‚îÄ deploy.sh                    # Main deployment script
‚îú‚îÄ‚îÄ generate-config.sh           # Generates configs from templates
‚îú‚îÄ‚îÄ setup-environments.sh        # Sets up multiple environments (dev/qa/prod)
‚îî‚îÄ‚îÄ ssl-params.conf             # SSL configuration parameters
```

### Configuration Files
```
deployment/configs/
‚îú‚îÄ‚îÄ deploy.conf                  # Standard deployment (full domain)
‚îú‚îÄ‚îÄ deploy-pathbased.conf       # Path-based routing (/dev/, /staging/)
‚îî‚îÄ‚îÄ deploy-subdomain.conf       # Subdomain-based environments
```

### Template Files
```
deployment/templates/
‚îú‚îÄ‚îÄ nginx.conf.template              # Standard nginx (full domain)
‚îú‚îÄ‚îÄ nginx-pathbased.conf.template    # Path-based nginx (location blocks)
‚îú‚îÄ‚îÄ gunicorn.conf.template           # Gunicorn configuration
‚îú‚îÄ‚îÄ systemd-socket.template          # Systemd socket unit template
‚îî‚îÄ‚îÄ systemd-service-socket.template  # Systemd service template (socket activation)
```

### Systemd Files
```
deployment/systemd/
‚îú‚îÄ‚îÄ template.service            # Ready-to-use systemd service file
‚îî‚îÄ‚îÄ template.socket             # Ready-to-use systemd socket file
ssl-params.conf             # Reusable SSL parameters
```

## Deployment Patterns

### 1. Standard Deployment (Full Domain)
- App URL: `https://myapp.purdue.edu`
- Config: `deploy.conf`
- Use when: App owns the entire domain

### 2. Path-Based Deployment
- App URL: `https://server.purdue.edu/dev/`
- Config: `deploy-pathbased.conf`
- Use when: Multiple apps on same domain with URL prefixes
- Features: Systemd socket activation, shared nginx server

### 3. Subdomain Deployment (Current Target)
- App URLs:
  - `https://django-template-dev.ag.purdue.edu`
  - `https://django-template-qa.ag.purdue.edu`
  - `https://django-template-prod.ag.purdue.edu`
- Config: `deploy-subdomain.conf`
- Use when: Multiple environments with subdomain separation

## Quick Start for AG Purdue Deployment

### 1. Initial Setup (Run Once)
```bash
# Set up all three environments
sudo ./setup-environments.sh

# This creates:
# - /etc/django-template-dev/deploy.conf
# - /etc/django-template-qa/deploy.conf
# - /etc/django-template-prod/deploy.conf
```

### 2. Configure Each Environment
```bash
# Edit each config file with proper values:
sudo vim /etc/django-template-dev/deploy.conf
# Set: DB_PASSWORD, SSL paths, email settings
```

### 3. Deploy Each Environment
```bash
# Deploy dev environment
sudo ./deploy.sh /etc/django-template-dev/deploy.conf

# Deploy qa environment
sudo ./deploy.sh /etc/django-template-qa/deploy.conf

# Deploy prod environment
sudo ./deploy.sh /etc/django-template-prod/deploy.conf
```

### 4. Configure nginx
```bash
# For each environment:
sudo cp /etc/django-template-dev/generated/nginx-django-template-dev.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/nginx-django-template-dev.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. Start Services
```bash
# For each environment:
sudo systemctl enable django-template-dev.socket
sudo systemctl start django-template-dev.socket
sudo systemctl status django-template-dev.socket
```

## Key Configuration Variables

### Essential Variables (Must Set)
- `DB_PASSWORD` - Database password for each environment
- `DJANGO_SECRET_KEY` - Unique per environment (auto-generated by setup script)
- `SSL_CERT` / `SSL_KEY` - SSL certificate paths

### Environment-Specific Settings
| Setting | Dev | QA | Prod |
|---------|-----|-----|------|
| `DJANGO_DEBUG` | True | False | False |
| `GUNICORN_WORKERS` | 2 | 4 | 8 |
| `GUNICORN_LOG_LEVEL` | debug | info | warning |
| `BACKUP_RETENTION_DAYS` | 7 | 14 | 90 |

## System Architecture

### With Socket Activation (Recommended)
```
nginx ‚Üí unix socket ‚Üí systemd ‚Üí gunicorn ‚Üí Django
         (managed by systemd)
```

### Standard Setup
```
nginx ‚Üí unix socket ‚Üí gunicorn ‚Üí Django
         (created by gunicorn)
```

## Testing Checklist

### Local Docker Testing
- [ ] Create `docker-compose.prod.yml` that mimics production
- [ ] Test nginx routing with path prefixes
- [ ] Test static file serving
- [ ] Test database connections
- [ ] Test gunicorn socket activation

### Server Testing
- [ ] Deploy dev environment first
- [ ] Verify nginx configuration
- [ ] Test static files load correctly
- [ ] Test Django admin interface
- [ ] Test API endpoints
- [ ] Test health check endpoint
- [ ] Verify logs are being written
- [ ] Test systemd socket activation
- [ ] Test service restart/reload

## Important Notes

### Django Settings Required
For path-based routing, Django needs:
```python
FORCE_SCRIPT_NAME = os.environ.get('FORCE_SCRIPT_NAME', '')
STATIC_URL = os.environ.get('STATIC_URL', '/static/')
MEDIA_URL = os.environ.get('MEDIA_URL', '/media/')
```

### React Configuration Required
For path-based routing, React needs:
```javascript
// In main.tsx or App.tsx
<BrowserRouter basename={process.env.REACT_APP_BASENAME || '/'}>
```

### Database Setup
Create databases for each environment:
```sql
CREATE DATABASE django_template_dev;
CREATE DATABASE django_template_qa;
CREATE DATABASE django_template_prod;
CREATE USER django_template_user WITH PASSWORD 'xxx';
GRANT ALL ON DATABASE django_template_dev TO django_template_user;
-- Repeat for qa and prod
```

## Troubleshooting

### Check Service Status
```bash
systemctl status django-template-dev.service
systemctl status django-template-dev.socket
journalctl -u django-template-dev -f
```

### Check Logs
```bash
tail -f /var/log/django-template-dev/error.log
tail -f /var/log/django-template-dev/access.log
tail -f /var/log/nginx/error.log
```

### Test Socket
```bash
curl --unix-socket /run/gunicorn_django-template-dev.sock http://localhost/api/health/
```

### Common Issues
1. **Permission denied on socket**: Check socket ownership in systemd socket file
2. **502 Bad Gateway**: Check if gunicorn service is running
3. **Static files 404**: Verify STATIC_ROOT and nginx alias paths match
4. **CSRF errors**: Ensure ALLOWED_HOSTS includes the domain

## Next Steps

1. **Immediate**: Test deployment on actual server with dev environment
2. **Short-term**: Create Docker setup that emulates production
3. **Medium-term**: Add monitoring and alerting
4. **Long-term**: CI/CD pipeline for automated deployments

## Contact for This Setup

This deployment system was designed for AG Purdue's infrastructure where:
- Multiple environments share a server
- Each environment gets a subdomain
- nginx user runs the application
- Systemd socket activation is preferred
- SSL certificates are managed centrally
